<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zen Fill Pro - Physics Edition</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>
    <script>
      window.adsbygoogle = window.adsbygoogle || [];
      var adBreak = adConfig = function(o) { adsbygoogle.push(o); }
      adConfig({ preloadAdBreaks: 'on' });
    </script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        #ui-overlay { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); width: 100%; height: 100%; z-index: 50; }
        .ui-content { text-align: center; width: 90%; max-width: 400px; }
        h1 { font-size: 50px; color: #00ffff; text-shadow: 0 0 20px #00ffff; margin-bottom: 20px; }
        input { padding: 15px; font-size: 18px; border-radius: 5px; border: 2px solid #00ffff; background: #111; color: white; text-align: center; margin-bottom: 20px; width: 80%; }
        button { padding: 18px; font-size: 18px; background: #00ffff; border: none; cursor: pointer; border-radius: 50px; font-weight: bold; width: 85%; transition: 0.3s; color: black; margin-bottom: 10px; }
        button:hover { background: #fff; transform: scale(1.05); }
        .secondary-btn { background: #333; color: white; border: 1px solid #00ffff; }
        #score-box { position: absolute; top: 20px; left: 20px; color: #00ffff; font-size: 24px; font-weight: bold; font-family: monospace; z-index: 10; }
        #ad-loading { display: none; position: absolute; z-index: 100; background: #000; width: 100%; height: 100%; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
        .loader { border: 5px solid #333; border-top: 5px solid #00ffff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #timer-text { font-size: 14px; color: #777; margin-top: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        canvas { display: block; width: 100vmin; height: 100vmin; border: 1px solid #222; }
    </style>
</head>
<body>

    <div id="score-box">0 / Loading...</div>
    
    <div id="ad-loading">
        <div class="loader"></div>
        <p id="loading-status">INITIALIZING SYSTEMS...</p>
        <p id="timer-text">Connecting to Ad Server (6s)...</p>
        <button id="skip-ad-btn" style="display:none; width: auto;" onclick="startGame()">PLAY FOR FREE</button>
    </div>

    <div id="ui-overlay">
        <div id="entry-screen" class="ui-content">
            <h1>ZEN FILL</h1>
            <input type="text" id="player-name" placeholder="ENTER NAME">
            <button onclick="requestAd('reward')">WATCH AD TO PLAY</button>
        </div>
        <div id="end-screen" class="ui-content" style="display:none;">
            <h1 id="nice-msg">BLAST!</h1>
            <button onclick="location.reload()">PLAY AGAIN</button>
        </div>
        <div id="pause-screen" class="ui-content" style="display:none;">
            <h1>PAUSED</h1>
            <button onclick="resumeGame()">CONTINUE</button>
            <button class="secondary-btn" onclick="location.reload()">RESTART</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

<script>
    // 1. ADAPTIVE CONFIGURATION (SET ONLY ONCE)
    const isMobile = window.innerWidth < 768;
    const speed = 4.5;
    const ballRad = isMobile ? 12 : 6; 
    const target = isMobile ? 750 : 1500; 
    const ringRad = 350;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 800;

    let balls = [];
    let rotation = 0;
    let isRunning = false;
    let isBlasted = false;
    let gameStarted = false;
    let wakeLock = null;

    // Set initial score display
    document.getElementById('score-box').innerText = "0 / " + target;

    // --- SOUND SYSTEM ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(f, t='sine', d=0.05, s=false) {
        try {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            if(s) o.frequency.exponentialRampToValueAtTime(f*0.1, audioCtx.currentTime+d);
            g.gain.setValueAtTime(0.02, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime+d);
        } catch(e){}
    }

    // --- WAKE LOCK ---
    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    // --- TAB CHANGE DETECTION ---
    document.addEventListener("visibilitychange", () => { if (document.hidden && isRunning) pauseGame(); });

    // --- AD LOGIC (FIXED 6s TIMER) ---
    function requestAd(type) {
        const loadingDiv = document.getElementById('ad-loading');
        const timerText = document.getElementById('timer-text');
        const skipBtn = document.getElementById('skip-ad-btn');
        loadingDiv.style.display = 'flex';
        skipBtn.style.display = 'none';
        
        let timeLeft = 6;
        let countdown = setInterval(() => {
            timeLeft--;
            if (timeLeft > 0) {
                timerText.innerText = "Connecting to Ad Server (" + timeLeft + "s)...";
            } else {
                timerText.innerText = "Ad server not responding...";
                skipBtn.style.display = "block"; 
                clearInterval(countdown);
            }
        }, 1000);

        adBreak({
            type: type,
            name: 'game_start',
            beforeReward: (show) => { show(); },
            adViewed: () => { clearInterval(countdown); startGame(); },
            adDismissed: () => { clearInterval(countdown); startGame(); },
            adBreakDone: () => { clearInterval(countdown); if (!gameStarted) startGame(); }
        });
    }

    // --- PHYSICS (MARBLE STYLE) ---
    function resolveCollision(b1, b2) {
    const dx = b2.x - b1.x;
    const dy = b2.y - b1.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    // Dynamic check based on current ball size
    if (distance < ballRad * 2 && distance > 0) {
        // --- POSITION PROJECTION (The Pressure Fix) ---
        // Calculate how much they are overlapping
        const overlap = (ballRad * 2 - distance) / 2;
        const nx = dx / distance;
        const ny = dy / distance;

        // Physically push them apart so they don't stay "stuck"
        b1.x -= nx * overlap;
        b1.y -= ny * overlap;
        b2.x += nx * overlap;
        b2.y += ny * overlap;

        // --- VELOCITY RESOLUTION ---
        // Normal velocity components
        const v1n = b1.vx * nx + b1.vy * ny;
        const v2n = b2.vx * nx + b2.vy * ny;

        // Perfect elastic bounce
        const vDiff = v1n - v2n;
        if (vDiff > 0) {
            b1.vx -= vDiff * nx;
            b1.vy -= vDiff * ny;
            b2.vx += vDiff * nx;
            b2.vy += vDiff * ny;
        }
    }
}

    function startGame() {
        if (gameStarted) return;
        gameStarted = true;
        requestWakeLock();
        document.getElementById('ad-loading').style.display = 'none';
        document.getElementById('ui-overlay').style.display = 'none';
        if (balls.length === 0) balls.push({x:400, y:300, vx:speed, vy:speed, color:'#00ffff', inside:true});
        isRunning = true;
        requestAnimationFrame(animate);
    }

    function pauseGame() {
        isRunning = false;
        document.getElementById('ui-overlay').style.display = 'flex';
        document.getElementById('pause-screen').style.display = 'block';
        document.getElementById('entry-screen').style.display = 'none';
    }

    function resumeGame() {
        document.getElementById('ui-overlay').style.display = 'none';
        document.getElementById('pause-screen').style.display = 'none';
        isRunning = true;
        requestAnimationFrame(animate);
    }

    function animate() {
    if(!isRunning && !isBlasted) return;
    
    // Clear Canvas
    ctx.fillStyle = 'black'; 
    ctx.fillRect(0, 0, 800, 800);
    
    if(!isBlasted) rotation += 0.015;

    let activeCount = 0;

    // 1. Resolve Ball-to-Ball Collisions
    for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
            if (balls[i].inside && balls[j].inside) {
                resolveCollision(balls[i], balls[j]);
            }
        }
    }

    // 2. Update Position, Speed, and Ring Collision
    for(let i = balls.length - 1; i >= 0; i--) {
        let b = balls[i];
        
        // FORCE UNIFORM SPEED
        let magnitude = Math.sqrt(b.vx * b.vx + b.vy * b.vy);
        if (magnitude !== 0) {
            b.vx = (b.vx / magnitude) * speed;
            b.vy = (b.vy / magnitude) * speed;
        }

        b.x += b.vx; 
        b.y += b.vy;

        // --- HARD BOUNDARY DETECTION ---
        let d = Math.sqrt((b.x - 400)**2 + (b.y - 400)**2);
        
        if (!isBlasted && b.inside && d + ballRad > ringRad) {
            let ang = Math.atan2(b.y - 400, b.x - 400);
            let rel = (ang - rotation) % (Math.PI * 2);
            if(rel < 0) rel += Math.PI * 2;
            
            if(rel > 0.25) {
                // REFLECT: Change velocity
                let nx = (b.x - 400) / d, ny = (b.y - 400) / d;
                let dot = b.vx * nx + b.vy * ny;
                b.vx -= 2 * dot * nx; b.vy -= 2 * dot * ny;

                // HARD SNAP: Physically move ball inside the border
                // This stops the "soft" border effect
                b.x = 400 + nx * (ringRad - ballRad);
                b.y = 400 + ny * (ringRad - ballRad);
            } else {
                // EXIT: Ball goes through the gap
                b.inside = false;
                playSfx(150, 'square', 0.2, true);
                spawn();
            }
        }

        // 3. Draw Section
        if(b.inside) activeCount++;
        ctx.fillStyle = b.inside ? b.color : 'rgba(255,255,255,0.1)';
        ctx.beginPath(); 
        ctx.arc(b.x, b.y, ballRad, 0, Math.PI * 2); 
        ctx.fill();
        
        // Cleanup off-screen
        if (b.y > 1200 || b.y < -400 || b.x > 1200 || b.x < -400) balls.splice(i, 1);
    }

    // 4. Draw Ring
    if (!isBlasted) {
        ctx.beginPath(); 
        ctx.arc(400, 400, ringRad, rotation + 0.25, rotation + Math.PI * 2);
        ctx.strokeStyle = '#00ffff'; 
        ctx.lineWidth = 5; 
        ctx.stroke();
    }

    document.getElementById('score-box').innerText = activeCount + " / " + target;
    if (activeCount >= target && !isBlasted) triggerBlast();
    
    requestAnimationFrame(animate);
}

    function spawn() {
        const colors = ['#00ffff', '#ff00ff', '#00ffaa', '#ffff00', '#ffffff'];
        const c = colors[Math.floor(Math.random()*colors.length)];
        const ballCount = Math.random() > 0.8 ? 3 : 2; 
        for(let i=0; i < ballCount; i++) {
            let a = Math.random() * Math.PI * 2;
            balls.push({
                x: 400 + (Math.random()-0.5)*10, y: 400 + (Math.random()-0.5)*10, 
                vx: Math.cos(a) * speed, vy: Math.sin(a) * speed, 
                color: c, inside: true
            });
        }
    }

    function triggerBlast() {
        isBlasted = true;
        playSfx(50, 'sawtooth', 0.8, true);
        balls.forEach(b => {
            let ang = Math.atan2(b.y-400, b.x-400);
            let force = 5 + Math.random() * 10;
            b.vx = Math.cos(ang) * force; b.vy = Math.sin(ang) * force;
        });
        setTimeout(() => {
            document.getElementById('ui-overlay').style.display = 'flex';
            document.getElementById('end-screen').style.display = 'block';
            document.getElementById('pause-screen').style.display = 'none';
        }, 2000);
    }
</script>
</body>
</html>
